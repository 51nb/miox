'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var cov_2l8e0ex6hh = function () {
  var path = '/Users/shenyunjie/CodeBox/miox/src/miox-vue2x/src/engine.js',
      hash = '72ca40c569d5d3677f486809dd4505221c79a146',
      global = new Function('return this')(),
      gcv = '__coverage__',
      coverageData = {
    path: '/Users/shenyunjie/CodeBox/miox/src/miox-vue2x/src/engine.js',
    statementMap: {
      '0': {
        start: {
          line: 14,
          column: 4
        },
        end: {
          line: 14,
          column: 19
        }
      },
      '1': {
        start: {
          line: 59,
          column: 4
        },
        end: {
          line: 59,
          column: 42
        }
      },
      '2': {
        start: {
          line: 60,
          column: 4
        },
        end: {
          line: 85,
          column: 7
        }
      },
      '3': {
        start: {
          line: 61,
          column: 6
        },
        end: {
          line: 84,
          column: 7
        }
      },
      '4': {
        start: {
          line: 62,
          column: 26
        },
        end: {
          line: 62,
          column: 28
        }
      },
      '5': {
        start: {
          line: 64,
          column: 8
        },
        end: {
          line: 74,
          column: 9
        }
      },
      '6': {
        start: {
          line: 66,
          column: 12
        },
        end: {
          line: 66,
          column: 52
        }
      },
      '7': {
        start: {
          line: 67,
          column: 12
        },
        end: {
          line: 67,
          column: 18
        }
      },
      '8': {
        start: {
          line: 76,
          column: 8
        },
        end: {
          line: 76,
          column: 44
        }
      },
      '9': {
        start: {
          line: 77,
          column: 8
        },
        end: {
          line: 77,
          column: 36
        }
      },
      '10': {
        start: {
          line: 79,
          column: 8
        },
        end: {
          line: 81,
          column: 11
        }
      },
      '11': {
        start: {
          line: 80,
          column: 10
        },
        end: {
          line: 80,
          column: 46
        }
      },
      '12': {
        start: {
          line: 80,
          column: 31
        },
        end: {
          line: 80,
          column: 44
        }
      },
      '13': {
        start: {
          line: 83,
          column: 8
        },
        end: {
          line: 83,
          column: 18
        }
      },
      '14': {
        start: {
          line: 89,
          column: 4
        },
        end: {
          line: 89,
          column: 22
        }
      },
      '15': {
        start: {
          line: 93,
          column: 4
        },
        end: {
          line: 93,
          column: 35
        }
      },
      '16': {
        start: {
          line: 97,
          column: 4
        },
        end: {
          line: 97,
          column: 34
        }
      },
      '17': {
        start: {
          line: 101,
          column: 4
        },
        end: {
          line: 101,
          column: 34
        }
      },
      '18': {
        start: {
          line: 105,
          column: 4
        },
        end: {
          line: 105,
          column: 53
        }
      },
      '19': {
        start: {
          line: 109,
          column: 4
        },
        end: {
          line: 109,
          column: 51
        }
      },
      '20': {
        start: {
          line: 113,
          column: 4
        },
        end: {
          line: 113,
          column: 40
        }
      },
      '21': {
        start: {
          line: 117,
          column: 4
        },
        end: {
          line: 117,
          column: 35
        }
      },
      '22': {
        start: {
          line: 118,
          column: 4
        },
        end: {
          line: 118,
          column: 25
        }
      },
      '23': {
        start: {
          line: 122,
          column: 4
        },
        end: {
          line: 122,
          column: 33
        }
      },
      '24': {
        start: {
          line: 122,
          column: 26
        },
        end: {
          line: 122,
          column: 33
        }
      },
      '25': {
        start: {
          line: 123,
          column: 20
        },
        end: {
          line: 123,
          column: 56
        }
      },
      '26': {
        start: {
          line: 124,
          column: 22
        },
        end: {
          line: 124,
          column: 58
        }
      },
      '27': {
        start: {
          line: 125,
          column: 24
        },
        end: {
          line: 125,
          column: 60
        }
      },
      '28': {
        start: {
          line: 127,
          column: 4
        },
        end: {
          line: 127,
          column: 42
        }
      },
      '29': {
        start: {
          line: 128,
          column: 4
        },
        end: {
          line: 128,
          column: 35
        }
      },
      '30': {
        start: {
          line: 129,
          column: 4
        },
        end: {
          line: 129,
          column: 39
        }
      },
      '31': {
        start: {
          line: 130,
          column: 4
        },
        end: {
          line: 130,
          column: 40
        }
      },
      '32': {
        start: {
          line: 131,
          column: 4
        },
        end: {
          line: 131,
          column: 41
        }
      },
      '33': {
        start: {
          line: 133,
          column: 4
        },
        end: {
          line: 133,
          column: 23
        }
      }
    },
    fnMap: {
      '0': {
        name: '(anonymous_0)',
        decl: {
          start: {
            line: 13,
            column: 2
          },
          end: {
            line: 13,
            column: 3
          }
        },
        loc: {
          start: {
            line: 13,
            column: 19
          },
          end: {
            line: 56,
            column: 3
          }
        },
        line: 13
      },
      '1': {
        name: '(anonymous_1)',
        decl: {
          start: {
            line: 58,
            column: 2
          },
          end: {
            line: 58,
            column: 3
          }
        },
        loc: {
          start: {
            line: 58,
            column: 33
          },
          end: {
            line: 86,
            column: 3
          }
        },
        line: 58
      },
      '2': {
        name: '(anonymous_2)',
        decl: {
          start: {
            line: 60,
            column: 29
          },
          end: {
            line: 60,
            column: 30
          }
        },
        loc: {
          start: {
            line: 60,
            column: 50
          },
          end: {
            line: 85,
            column: 5
          }
        },
        line: 60
      },
      '3': {
        name: '(anonymous_3)',
        decl: {
          start: {
            line: 79,
            column: 54
          },
          end: {
            line: 79,
            column: 55
          }
        },
        loc: {
          start: {
            line: 79,
            column: 66
          },
          end: {
            line: 81,
            column: 9
          }
        },
        line: 79
      },
      '4': {
        name: '(anonymous_4)',
        decl: {
          start: {
            line: 80,
            column: 25
          },
          end: {
            line: 80,
            column: 26
          }
        },
        loc: {
          start: {
            line: 80,
            column: 31
          },
          end: {
            line: 80,
            column: 44
          }
        },
        line: 80
      },
      '5': {
        name: '(anonymous_5)',
        decl: {
          start: {
            line: 88,
            column: 2
          },
          end: {
            line: 88,
            column: 3
          }
        },
        loc: {
          start: {
            line: 88,
            column: 24
          },
          end: {
            line: 90,
            column: 3
          }
        },
        line: 88
      },
      '6': {
        name: '(anonymous_6)',
        decl: {
          start: {
            line: 92,
            column: 2
          },
          end: {
            line: 92,
            column: 3
          }
        },
        loc: {
          start: {
            line: 92,
            column: 23
          },
          end: {
            line: 94,
            column: 3
          }
        },
        line: 92
      },
      '7': {
        name: '(anonymous_7)',
        decl: {
          start: {
            line: 96,
            column: 2
          },
          end: {
            line: 96,
            column: 3
          }
        },
        loc: {
          start: {
            line: 96,
            column: 22
          },
          end: {
            line: 98,
            column: 3
          }
        },
        line: 96
      },
      '8': {
        name: '(anonymous_8)',
        decl: {
          start: {
            line: 100,
            column: 2
          },
          end: {
            line: 100,
            column: 3
          }
        },
        loc: {
          start: {
            line: 100,
            column: 22
          },
          end: {
            line: 102,
            column: 3
          }
        },
        line: 100
      },
      '9': {
        name: '(anonymous_9)',
        decl: {
          start: {
            line: 104,
            column: 2
          },
          end: {
            line: 104,
            column: 3
          }
        },
        loc: {
          start: {
            line: 104,
            column: 41
          },
          end: {
            line: 106,
            column: 3
          }
        },
        line: 104
      },
      '10': {
        name: '(anonymous_10)',
        decl: {
          start: {
            line: 108,
            column: 2
          },
          end: {
            line: 108,
            column: 3
          }
        },
        loc: {
          start: {
            line: 108,
            column: 39
          },
          end: {
            line: 110,
            column: 3
          }
        },
        line: 108
      },
      '11': {
        name: '(anonymous_11)',
        decl: {
          start: {
            line: 112,
            column: 2
          },
          end: {
            line: 112,
            column: 3
          }
        },
        loc: {
          start: {
            line: 112,
            column: 18
          },
          end: {
            line: 114,
            column: 3
          }
        },
        line: 112
      },
      '12': {
        name: '(anonymous_12)',
        decl: {
          start: {
            line: 116,
            column: 2
          },
          end: {
            line: 116,
            column: 3
          }
        },
        loc: {
          start: {
            line: 116,
            column: 12
          },
          end: {
            line: 119,
            column: 3
          }
        },
        line: 116
      },
      '13': {
        name: '(anonymous_13)',
        decl: {
          start: {
            line: 121,
            column: 2
          },
          end: {
            line: 121,
            column: 3
          }
        },
        loc: {
          start: {
            line: 121,
            column: 22
          },
          end: {
            line: 134,
            column: 3
          }
        },
        line: 121
      }
    },
    branchMap: {
      '0': {
        loc: {
          start: {
            line: 64,
            column: 8
          },
          end: {
            line: 74,
            column: 9
          }
        },
        type: 'switch',
        locations: [{
          start: {
            line: 65,
            column: 10
          },
          end: {
            line: 67,
            column: 18
          }
        }],
        line: 64
      },
      '1': {
        loc: {
          start: {
            line: 76,
            column: 30
          },
          end: {
            line: 76,
            column: 43
          }
        },
        type: 'binary-expr',
        locations: [{
          start: {
            line: 76,
            column: 30
          },
          end: {
            line: 76,
            column: 37
          }
        }, {
          start: {
            line: 76,
            column: 41
          },
          end: {
            line: 76,
            column: 43
          }
        }],
        line: 76
      },
      '2': {
        loc: {
          start: {
            line: 122,
            column: 4
          },
          end: {
            line: 122,
            column: 33
          }
        },
        type: 'if',
        locations: [{
          start: {
            line: 122,
            column: 4
          },
          end: {
            line: 122,
            column: 33
          }
        }, {
          start: {
            line: 122,
            column: 4
          },
          end: {
            line: 122,
            column: 33
          }
        }],
        line: 122
      }
    },
    s: {
      '0': 0,
      '1': 0,
      '2': 0,
      '3': 0,
      '4': 0,
      '5': 0,
      '6': 0,
      '7': 0,
      '8': 0,
      '9': 0,
      '10': 0,
      '11': 0,
      '12': 0,
      '13': 0,
      '14': 0,
      '15': 0,
      '16': 0,
      '17': 0,
      '18': 0,
      '19': 0,
      '20': 0,
      '21': 0,
      '22': 0,
      '23': 0,
      '24': 0,
      '25': 0,
      '26': 0,
      '27': 0,
      '28': 0,
      '29': 0,
      '30': 0,
      '31': 0,
      '32': 0,
      '33': 0
    },
    f: {
      '0': 0,
      '1': 0,
      '2': 0,
      '3': 0,
      '4': 0,
      '5': 0,
      '6': 0,
      '7': 0,
      '8': 0,
      '9': 0,
      '10': 0,
      '11': 0,
      '12': 0,
      '13': 0
    },
    b: {
      '0': [0],
      '1': [0, 0],
      '2': [0, 0]
    },
    _coverageSchema: '332fd63041d2c1bcb487cc26dd0d5f7d97098a6c'
  },
      coverage = global[gcv] || (global[gcv] = {});

  if (coverage[path] && coverage[path].hash === hash) {
    return coverage[path];
  }

  coverageData.hash = hash;
  return coverage[path] = coverageData;
}(); /**
      * Created by evio on 2017/3/20.
      */


var _isClass = require('is-class');

var _isClass2 = _interopRequireDefault(_isClass);

var _webview = require('./webview');

var _webview2 = _interopRequireDefault(_webview);

var _vue = require('vue');

var _vue2 = _interopRequireDefault(_vue);

var _directives = require('./directives');

var _directives2 = _interopRequireDefault(_directives);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Vue2x 驱动引擎
 */
var Engine = function () {
  function Engine(ctx) {
    (0, _classCallCheck3.default)(this, Engine);
    cov_2l8e0ex6hh.f[0]++;
    cov_2l8e0ex6hh.s[0]++;

    this.ctx = ctx;

    /* istanbul ignore next */
    ctx.on('app:end', function () {
      if (ctx.env === 'server') return;
      var scripts = ctx.element.querySelectorAll('script');
      var i = scripts.length;

      while (i--) {
        var script = scripts[i];
        if (script && script.parentNode) {
          script.parentNode.removeChild(script);
        }
      }
    });

    /* istanbul ignore next */
    ctx.on('server:render:polyfill', function (context) {
      var store = ctx.get('vuex');
      if (store) {
        context.state = store.state;
      }
    });

    /* istanbul ignore next */
    ctx.on('client:render:polyfill', function () {
      var store = ctx.get('vuex');
      if (global.__INITIAL_STATE__ && store) {
        store.replaceState(global.__INITIAL_STATE__);
      }
    });

    /* istanbul ignore next */
    ctx.on('client:render:mount', function (viewModule) {
      if (!ctx.element) throw new Error('miss ctx.element');
      if (!viewModule) throw new Error('miss view module');

      var el = ctx.element.querySelector('[data-server-rendered=true]');
      if (!el) throw new Error('miss data-server-rendered element');

      viewModule.$mount(el);
    });
  }

  (0, _createClass3.default)(Engine, [{
    key: 'create',
    value: function () {
      var _ref = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee(webview, options) {
        var _this = this;

        return _regenerator2.default.wrap(function _callee$(_context) {
          while (1) {
            switch (_context.prev = _context.next) {
              case 0:
                cov_2l8e0ex6hh.f[1]++;
                cov_2l8e0ex6hh.s[1]++;

                webview = checkWebViewObject(webview);
                cov_2l8e0ex6hh.s[2]++;
                _context.next = 6;
                return new Promise(function (resolve, reject) {
                  cov_2l8e0ex6hh.f[2]++;
                  cov_2l8e0ex6hh.s[3]++;

                  try {
                    var Arguments = (cov_2l8e0ex6hh.s[4]++, {});

                    cov_2l8e0ex6hh.s[5]++;
                    switch (_this.ctx.env) {
                      case 'web':
                        cov_2l8e0ex6hh.b[0][0]++;
                        cov_2l8e0ex6hh.s[6]++;

                        Arguments.el = _this.createWebViewRoot();
                        cov_2l8e0ex6hh.s[7]++;
                        break;
                      /* istanbul ignore next */
                      case 'client':
                        if (_this.ctx.installed) {
                          Arguments.el = _this.createWebViewRoot();
                        }
                        break;
                    }

                    cov_2l8e0ex6hh.s[8]++;
                    Arguments.propsData = (cov_2l8e0ex6hh.b[1][0]++, options) || (cov_2l8e0ex6hh.b[1][1]++, {});
                    cov_2l8e0ex6hh.s[9]++;
                    Arguments.extends = _webview2.default;

                    cov_2l8e0ex6hh.s[10]++;
                    new webview(Arguments).$on('webview:created', function () {
                      var _this2 = this;

                      cov_2l8e0ex6hh.f[3]++;
                      cov_2l8e0ex6hh.s[11]++;

                      this.$nextTick(function () {
                        cov_2l8e0ex6hh.f[4]++;
                        cov_2l8e0ex6hh.s[12]++;
                        return resolve(_this2);
                      });
                    });
                  } catch (e) {
                    cov_2l8e0ex6hh.s[13]++;

                    reject(e);
                  }
                });

              case 6:
                return _context.abrupt('return', _context.sent);

              case 7:
              case 'end':
                return _context.stop();
            }
          }
        }, _callee, this);
      }));

      function create(_x, _x2) {
        return _ref.apply(this, arguments);
      }

      return create;
    }()
  }, {
    key: 'destroy',
    value: function () {
      var _ref2 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee2(target) {
        return _regenerator2.default.wrap(function _callee2$(_context2) {
          while (1) {
            switch (_context2.prev = _context2.next) {
              case 0:
                cov_2l8e0ex6hh.f[5]++;
                cov_2l8e0ex6hh.s[14]++;

                target.$destroy();

              case 3:
              case 'end':
                return _context2.stop();
            }
          }
        }, _callee2, this);
      }));

      function destroy(_x3) {
        return _ref2.apply(this, arguments);
      }

      return destroy;
    }()
  }, {
    key: 'active',
    value: function () {
      var _ref3 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee3(target) {
        return _regenerator2.default.wrap(function _callee3$(_context3) {
          while (1) {
            switch (_context3.prev = _context3.next) {
              case 0:
                cov_2l8e0ex6hh.f[6]++;
                cov_2l8e0ex6hh.s[15]++;

                target.$emit('webview:active');

              case 3:
              case 'end':
                return _context3.stop();
            }
          }
        }, _callee3, this);
      }));

      function active(_x4) {
        return _ref3.apply(this, arguments);
      }

      return active;
    }()
  }, {
    key: 'enter',
    value: function () {
      var _ref4 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee4(target) {
        return _regenerator2.default.wrap(function _callee4$(_context4) {
          while (1) {
            switch (_context4.prev = _context4.next) {
              case 0:
                cov_2l8e0ex6hh.f[7]++;
                cov_2l8e0ex6hh.s[16]++;

                target.$emit('webview:enter');

              case 3:
              case 'end':
                return _context4.stop();
            }
          }
        }, _callee4, this);
      }));

      function enter(_x5) {
        return _ref4.apply(this, arguments);
      }

      return enter;
    }()
  }, {
    key: 'leave',
    value: function () {
      var _ref5 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee5(target) {
        return _regenerator2.default.wrap(function _callee5$(_context5) {
          while (1) {
            switch (_context5.prev = _context5.next) {
              case 0:
                cov_2l8e0ex6hh.f[8]++;
                cov_2l8e0ex6hh.s[17]++;

                target.$emit('webview:leave');

              case 3:
              case 'end':
                return _context5.stop();
            }
          }
        }, _callee5, this);
      }));

      function leave(_x6) {
        return _ref5.apply(this, arguments);
      }

      return leave;
    }()
  }, {
    key: 'searchchange',
    value: function () {
      var _ref6 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee6(target, prev, next) {
        return _regenerator2.default.wrap(function _callee6$(_context6) {
          while (1) {
            switch (_context6.prev = _context6.next) {
              case 0:
                cov_2l8e0ex6hh.f[9]++;
                cov_2l8e0ex6hh.s[18]++;

                target.$emit('webview:searchchange', prev, next);

              case 3:
              case 'end':
                return _context6.stop();
            }
          }
        }, _callee6, this);
      }));

      function searchchange(_x7, _x8, _x9) {
        return _ref6.apply(this, arguments);
      }

      return searchchange;
    }()
  }, {
    key: 'hashchange',
    value: function () {
      var _ref7 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee7(target, prev, next) {
        return _regenerator2.default.wrap(function _callee7$(_context7) {
          while (1) {
            switch (_context7.prev = _context7.next) {
              case 0:
                cov_2l8e0ex6hh.f[10]++;
                cov_2l8e0ex6hh.s[19]++;

                target.$emit('webview:hashchange', prev, next);

              case 3:
              case 'end':
                return _context7.stop();
            }
          }
        }, _callee7, this);
      }));

      function hashchange(_x10, _x11, _x12) {
        return _ref7.apply(this, arguments);
      }

      return hashchange;
    }()
  }, {
    key: 'element',
    value: function element(target) {
      cov_2l8e0ex6hh.f[11]++;
      cov_2l8e0ex6hh.s[20]++;

      return target.__MioxInjectElement__;
    }
  }, {
    key: 'install',
    value: function install() {
      cov_2l8e0ex6hh.f[12]++;
      cov_2l8e0ex6hh.s[21]++;

      _vue2.default.prototype.$miox = this.ctx;
      cov_2l8e0ex6hh.s[22]++;
      (0, _directives2.default)(this.ctx);
    }
  }, {
    key: 'createWebViewRoot',
    value: function createWebViewRoot() {
      cov_2l8e0ex6hh.f[13]++;
      cov_2l8e0ex6hh.s[23]++;

      if (!global.document) {
          cov_2l8e0ex6hh.b[2][0]++;
          cov_2l8e0ex6hh.s[24]++;
          return;
        } else {
        cov_2l8e0ex6hh.b[2][1]++;
      }var element = (cov_2l8e0ex6hh.s[25]++, global.document.createElement('div'));
      var container = (cov_2l8e0ex6hh.s[26]++, global.document.createElement('div'));
      var wrapElement = (cov_2l8e0ex6hh.s[27]++, global.document.createElement('div'));

      cov_2l8e0ex6hh.s[28]++;
      this.ctx.element.appendChild(element);
      cov_2l8e0ex6hh.s[29]++;
      element.appendChild(container);
      cov_2l8e0ex6hh.s[30]++;
      container.appendChild(wrapElement);
      cov_2l8e0ex6hh.s[31]++;
      element.classList.add('mx-webview');
      cov_2l8e0ex6hh.s[32]++;
      container.classList.add('mx-window');

      cov_2l8e0ex6hh.s[33]++;
      return wrapElement;
    }

    /* istanbul ignore next */

  }, {
    key: 'ssr',
    value: function ssr() {
      var _this3 = this;

      this.ctx.emit('app:start');
      return function () {
        var _ref8 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee8(options) {
          var url, app, ctx;
          return _regenerator2.default.wrap(function _callee8$(_context8) {
            while (1) {
              switch (_context8.prev = _context8.next) {
                case 0:
                  url = options.url, app = options.app, ctx = options.ctx;

                  _this3.ctx.$application = app;
                  _this3.ctx.$context = ctx;
                  _context8.next = 5;
                  return _this3.ctx.createServerProgress(url);

                case 5:
                  _context8.next = 7;
                  return _this3.ctx.emit('app:end');

                case 7:
                  if (!_this3.ctx.err) {
                    _context8.next = 11;
                    break;
                  }

                  throw _this3.ctx.err;

                case 11:
                  _context8.next = 13;
                  return _this3.ctx.emit('server:render:polyfill', options);

                case 13:
                  return _context8.abrupt('return', _this3.ctx.webView);

                case 14:
                case 'end':
                  return _context8.stop();
              }
            }
          }, _callee8, _this3);
        }));

        return function (_x13) {
          return _ref8.apply(this, arguments);
        };
      }();
    }
  }]);
  return Engine;
}();
/* istanbul ignore next */


exports.default = Engine;
function checkWebViewObject(webview) {
  if (!(0, _isClass2.default)(webview) && typeof webview !== 'function') {
    try {
      webview = _vue2.default.extend(webview);
    } catch (e) {
      throw new Error('`webview` argument is not a class object or a function or an object.');
    }
  }
  return webview;
}
module.exports = exports['default'];